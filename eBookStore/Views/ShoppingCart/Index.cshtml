@model IEnumerable<eBookStore.Models.ViewModels.BookViewModel>
@{
    ViewData["Title"] = "eBook Store - Book List";
		var currentUser = Context.Session.GetInt32("userId") ?? 0;
}

<div class="container py-5">
    <div class="row">
        <!-- Filters Section -->
        <div class="col-lg-3 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title mb-3">Filters</h5>
                    <form method="get">
                        <div class="mb-3">
                            <label class="form-label">Genre</label>
                            <select name="genreId" class="form-select">
                                <option value="">All Genres</option>
                                @foreach (var genre in Model.Select(x => x.genreModel).Distinct())
                                {
                                    <option value="@genre.id">@genre.name</option>
                                }
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Publisher</label>
                            <select name="publisherId" class="form-select">
                                <option value="">All Publishers</option>
                                @foreach (var publisher in Model.Select(x => x.publisherModel).Distinct())
                                {
                                    <option value="@publisher.id">@publisher.name</option>
                                }
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Rating</label>
                            <select name="minRating" class="form-select">
                                <option value="">Any Rating</option>
                                @for (int i = 4; i >= 1; i--)
                                {
                                    <option value="@i">@i+ Stars & Up</option>
                                }
                            </select>
                        </div>

                        <button type="submit" class="btn btn-primary w-100">Apply Filters</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Books Grid -->
        <div class="col-lg-9">
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                @foreach (var bookVM in Model)
                {
                    <div class="col">
                        <div class="card h-100 shadow-sm">
                            <!-- Book Cover -->
                            <img src="@bookVM.coverModel.imgName" class="card-img-top" 
                                 alt="@bookVM.book.title" style="height: 300px; object-fit: cover;">

                            <!-- Book Details -->
                            <div class="card-body">
                                <h5 class="card-title" style="height: 2.5em; overflow: hidden;">
                                    @bookVM.book.title
                                </h5>

                                <p class="card-text text-muted mb-1">
                                    by <a href="@Url.Action("Details", "Author", new { id = bookVM.authorModel.id })" 
                                       class="text-decoration-none">@bookVM.authorModel.name</a>
                                </p>

                                <!-- Rating -->
                                <div class="mb-2">
                                    @for (int i = 1; i <= 5; i++)
                                    {
                                        if (i <= bookVM.rating.starRating)
                                        {
                                            <i class="bi bi-star-fill text-warning"></i>
                                        }
                                        else
                                        {
                                            <i class="bi bi-star text-warning"></i>
                                        }
                                    }
                                    <span class="ms-1 text-muted">(@bookVM.rating.starRating)</span>
                                </div>

                                <!-- Genre -->
                                <div class="mb-2">
                                    <span class="badge bg-secondary">@bookVM.genreModel.name</span>
                                </div>

                                <!-- Price or Ownership Status -->
                                <div class="d-flex justify-content-between align-items-center">
                                    @if (bookVM.ownerUserIds.Contains(currentUser))
                                    {
                                        <span class="badge bg-success">In Library</span>
                                    }
                                    else
                                    {
                                        <h5 class="mb-0">$@bookVM.book.buyingPrice</h5>
                                    }
                                </div>
                            </div>

                            <!-- Card Footer -->
                            <div class="card-footer bg-white border-top-0">
                                <div class="d-grid gap-2">
                                    <a href="@Url.Action("Details", "Book", new { id = bookVM.book.id })" 
                                       class="btn btn-outline-primary">View Details</a>

                                    @if (!bookVM.ownerUserIds.Contains(currentUser))
                                    {
                                        <form asp-controller="Cart" asp-action="AddToCart" method="post">
                                            <input type="hidden" name="bookId" value="@bookVM.book.id" />
                                            <button type="submit" class="btn btn-primary w-100">Add to Cart</button>
                                        </form>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Preserve filter values after postback
        $(document).ready(function() {
            const urlParams = new URLSearchParams(window.location.search);
            $('select[name="genreId"]').val(urlParams.get('genreId'));
            $('select[name="publisherId"]').val(urlParams.get('publisherId'));
            $('select[name="minRating"]').val(urlParams.get('minRating'));
        });
    </script>
}
