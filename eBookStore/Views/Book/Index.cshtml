
@model eBookStore.Models.ViewModels.BookViewModel
@{
    ViewData["Title"] = "Book Page";
    var currentUserId = Context.Session.GetInt32("userId") ?? 0;
}


<div class="grid h-100 mt-5">
    <div class="row">
        @if (Model.book != null)
            {

            
                <div class="info-container w-50 p-1">
                    <h2 class="Title-container">@Model.book.title</h2>

                    <a><strong>Author:</strong> @Model.authorModel.name </a><br>
                    <a><strong>Published by:</strong> @string.Join(", ", Model.publishers.Select(p => p.name))</a><br>
                    <a><strong>Genre:</strong> @Model.genreModel.name</a><br>
                    <a><strong>Age limit:</strong> @Model.book.ageLimit</a><br>
                    <a><strong>Publish date:</strong> @Model.book.pubDate.ToString("yyyy-MM-dd")</a><br>
                    <a><strong>Rating:</strong> @Model.book.starRate</a><br>
                    
                    <div class="buyBorrowButtons">
                        @if(Model.book.onSale)
                        {
                            <a class="text-decoration-line-through">Old price: @Model.book.buyingPrice$</a><br>
                            <a
                            asp-controller="ShoppingCart" 
                            asp-action="AddToShoppingCart"
                            asp-route-bookId="@Model.book.id"
                            asp-route-userId="@currentUserId"
                            asp-route-format="pdf" 
                            asp-route-isBorrowed="false"
                            ><strong>Sale Price:</strong> @(Model.book.buyingPrice * Model.bookDiscountModel.discountPrecentage)$</a>
                        }
                        else
                        {
                            <a
                            asp-controller="ShoppingCart" 
                            asp-action="AddToShoppingCart"
                            asp-route-bookId="@Model.book.id"
                            asp-route-userId="@currentUserId"
                            asp-route-format="pdf" 
                            asp-route-isBorrowed="false">
                                <button>Buy: @Model.book.buyingPrice$</button>
                            </a>
                        }
                        
                        @if(Model.book.canBorrow)
                        {
                            <a
                            asp-controller="ShoppingCart" 
                            asp-action="AddToShoppingCart"
                            asp-route-bookId="@Model.book.id"
                            asp-route-format="pdf" 
                            asp-route-isBorrowed="true">
                                <button>Borrow: @Model.book.borrowPrice$</button>
                            </a>
                        }

                        

                    </div>
                    



                </div>

            }
            else{
                <p>No Book details aviable</p>
            }

            @if(@Model.coverModel != null)
            {
                <div class="cover-container w-50 p-1 d-flex" style="justify-content: end;">

                    <img src="\images\bookCovers\@Model.coverModel.imgName" class="bookCoverImg img-thumbnail" style="max-width: 280px;" alt="Cover_Photo">

                </div>

            }
    </div>
    

    <div class="Feedback-Container row">
        <hr>
        <h2>Reviews:</h2>
        @if (Model.feedbackModel != null && Model.feedbackModel.Any())
        {
            <div class="reviews-container" style="max-height: 400px; overflow-y: auto;">
                @foreach (var feedback in Model.feedbackModel)
                {
                    var isReviewOwner = currentUserId == (feedback.userModel?.id ?? 0);

                    <div class="card border-0 bg-light mb-3 review-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div class="d-flex align-items-center gap-2">
                                    <i class="bi bi-person-circle text-secondary"></i>
                                    <h6 class="card-subtitle mb-0">@feedback.userModel?.username</h6>
                                    <span class="badge bg-primary text-white">Verified Owner</span>
                                </div>
                                <div class="d-flex align-items-center gap-3">
                                    <small class="text-muted">
                                        <i class="bi bi-clock me-1"></i>
                                        @feedback.createdAt.ToString("MMM dd, yyyy")
                                    </small>
                                    @* Show delete button only if the review is by the current user *@
                                    @if (isReviewOwner)
                                    {
                                        <form asp-action="DeleteReview" 
                                            asp-route-bookId="@Model.book?.id" 
                                            asp-route-reviewId="@feedback.id" 
                                            method="post" 
                                            class="delete-review-form d-inline">
                                            <button type="submit" 
                                                    class="btn btn-link text-danger p-0 delete-review-btn"
                                                    onclick="return confirm('Are you sure you want to delete your review?')">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    }
                                </div>
                            </div>
                            <p class="card-text mb-0">@feedback.comment</p>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="text-center py-4 bg-light rounded-3">
                <i class="bi bi-chat-square text-muted display-4"></i>
                <p class="text-muted mt-2">No reviews yet.</p>
            </div>
        }




    </div>




</div>
<script>
</script>


